# Path: src/sutta_processor/optimizer/pool_manager.py
import json
import logging
from typing import Dict, Set
from .config import JS_OUTPUT_DIR, PRIMARY_BOOKS_LIST, PRIMARY_BOOKS_SET

logger = logging.getLogger("Optimizer.Pools")

class PoolManager:
    def __init__(self):
        # Lưu số lượng bài kinh hợp lệ: {"dn": 34, "an": 11000}
        self.book_counts: Dict[str, int] = {}
        # Tập hợp các sách đã xử lý thành công
        self.available_books: Set[str] = set()

    def register_book_count(self, book_id: str, count: int) -> None:
        """Worker gọi hàm này sau khi xử lý xong 1 cuốn sách."""
        if count > 0:
            self.book_counts[book_id] = count
            self.available_books.add(book_id)

    def generate_js_constants(self) -> None:
        """
        Sinh file constants.js.
        Sử dụng phép trừ tập hợp (Set Difference) để tìm Secondary Books.
        """
        # 1. Logic Set Difference: Secondary = Available - Primary
        # Đảm bảo loại bỏ các sách Primary ra khỏi danh sách phụ
        secondary_set = self.available_books - PRIMARY_BOOKS_SET
        sorted_secondary = sorted(list(secondary_set))
        
        # 2. Nội dung JS
        content = (
            "// Path: web/assets/modules/data/constants.js\n"
            "// Auto-generated by SuttaProcessor\n"
            "// Contains weighted counts for random distribution.\n\n"
            
            f"export const PRIMARY_BOOKS = {json.dumps(PRIMARY_BOOKS_LIST, indent=2)};\n\n"
            
            f"export const SECONDARY_BOOKS = {json.dumps(sorted_secondary, indent=2)};\n\n"
            
            "// Map: { book_id: valid_sutta_count }\n"
            f"export const SUTTA_COUNTS = {json.dumps(self.book_counts, indent=2, sort_keys=True)};\n"
        )

        # 3. Ghi file
        file_path = JS_OUTPUT_DIR / "data" / "constants.js"
        file_path.parent.mkdir(parents=True, exist_ok=True)
        
        with open(file_path, "w", encoding="utf-8") as f:
            f.write(content)
            
        logger.info(f"   ✨ Generated constants.js (Secondary: {len(sorted_secondary)} books)")