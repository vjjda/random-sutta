# Path: src/sutta_processor/optimizer/pool_manager.py
import json
import logging
from typing import Dict, Set, List
from .config import JS_OUTPUT_DIR, PRIMARY_BOOKS_LIST, PRIMARY_BOOKS_SET

logger = logging.getLogger("Optimizer.Pools")

class PoolManager:
    def __init__(self):
        # [UPDATED] Không cần self.book_counts để export nữa, 
        # nhưng vẫn giữ để logic nội bộ (nếu cần log) hoặc xóa đi cũng được.
        # Ở đây ta giữ lại để code Orchestrator không bị lỗi gọi hàm, nhưng không dùng để export.
        self.book_counts: Dict[str, int] = {}
        
        self.group_structure: Dict[str, List[str]] = {}
        self.sutta_universe: Set[str] = set()
        self.random_pools: Dict[str, List[str]] = {}

    def register_book_count(self, book_id: str, count: int, sub_counts: Dict[str, int] = None) -> None:
        # Hàm này vẫn giữ để Orchestrator gọi không bị lỗi, nhưng dữ liệu không được dùng để export JS
        if count >= 0:
            self.book_counts[book_id] = count
        if sub_counts:
            self.book_counts.update(sub_counts)

    def register_group_structure(self, parent_id: str, children: List[str]) -> None:
        self.group_structure[parent_id] = children

    def register_pools(self, pools: Dict[str, List[str]]) -> None:
        if pools:
            self.random_pools.update(pools)

    def set_sutta_universe(self, books: List[str]) -> None:
        self.sutta_universe = set(books)

    def generate_js_constants(self) -> None:
        # 1. Secondary Books Logic
        # [UPDATED] Xác định secondary dựa trên việc có Pool hay không, thay vì book_counts
        candidates = self.sutta_universe - PRIMARY_BOOKS_SET
        
        valid_secondary = []
        for book_id in candidates:
            # Chỉ đưa vào nếu sách đó có Pool thực sự
            if book_id in self.random_pools and len(self.random_pools[book_id]) > 0:
                valid_secondary.append(book_id)

        sorted_secondary = sorted(valid_secondary)
        
        # 2. Sort Sub-books
        for k in self.group_structure:
            self.group_structure[k].sort(key=lambda x: (len(x), x))

        # [UPDATED] Xóa SUTTA_COUNTS khỏi nội dung file
        content = (
            "// Path: web/assets/modules/data/constants.js\n"
            "// Auto-generated by SuttaProcessor\n\n"
            f"export const PRIMARY_BOOKS = {json.dumps(PRIMARY_BOOKS_LIST, indent=2)};\n\n"
            f"export const SECONDARY_BOOKS = {json.dumps(sorted_secondary, indent=2)};\n\n"
            "// Group mapping for Split Books (e.g. an -> [an1, an2...])\n"
            f"export const SUB_BOOKS = {json.dumps(self.group_structure, indent=2)};\n\n"
            "// Master Random Pools (ID Lists)\n"
            "// Count is derived from RANDOM_POOLS[id].length\n"
            f"export const RANDOM_POOLS = {json.dumps(self.random_pools, separators=(',', ':'))};\n"
        )

        file_path = JS_OUTPUT_DIR / "data" / "constants.js"
        file_path.parent.mkdir(parents=True, exist_ok=True)
        
        with open(file_path, "w", encoding="utf-8") as f:
            f.write(content)
            
        logger.info(f"   ✨ Generated constants.js (Cleaned SUTTA_COUNTS)")